# 通知詳細_NT-001 会員登録確認メール

## 1. 通知ID

`NT-001`

## 2. 通知名

会員登録確認メール

## 3. 通知概要

新規ユーザーが会員登録フォームを送信した際、登録の有効性を確認するためのリンクを含むメールを送信する。ユーザーがリンクをクリックすると、メールアドレスの所有が確認され、登録手続きが完了する。

## 4. 送信チャネル

- Email

## 5. 送信タイミング

- ユーザーが **POST** `/api/auth/register` を実行し、登録申請が成功した直後  
- 登録申請データをDBに保存後、即時送信

## 6. 送信レイアウト／テンプレート

- 件名：  
  ```
  【ECサイト】会員登録のご確認
  ```
- 本文（HTML + プレーンテキストのマルチパート）  
  ```html
  <h1>ECサイトへようこそ！</h1>
  <p>こんにちは {{userName}} 様、</p>
  <p>この度はECサイトにご登録いただきありがとうございます。下記のリンクをクリックして、メールアドレスの確認を完了してください。</p>
  <p><a href="{{verificationUrl}}">メールアドレスを確認する</a></p>
  <p>このリンクの有効期限は24時間です。有効期限を過ぎるとリンクは無効になりますのでご注意ください。</p>
  <hr>
  <p>―――――</p>
  <p>ECサイト運営事務局</p>
  ```
  プレーンテキスト版例：
  ```
  ECサイトへようこそ！

  こんにちは {{userName}} 様、

  この度はECサイトにご登録いただきありがとうございます。
  以下のURLをブラウザで開いて、メールアドレスの確認を完了してください。

  {{verificationUrl}}

  ※このリンクの有効期限は24時間です。

  ―――――
  ECサイト運営事務局
  ```

## 7. メールテンプレート変数定義

| 変数名             | データ型 | 必須 | 説明                                    | 備考                        |
|-------------------|--------|-----|---------------------------------------|----------------------------|
| userName          | string | O   | ユーザー名                              | 登録フォーム入力値            |
| verificationUrl   | string | O   | メールアドレス確認用のワンタイムURL       | `/api/auth/verify?token=…`  |
| expirationHours   | integer| O   | リンク有効期限（時間）                   | 24                           |
| supportEmail      | string | O   | 送信元問い合わせ用メールアドレス         | 例：support@example.com     |

## 8. バリデーション

| 対象               | ルール                                    | 発生タイミング       | メッセージID        |
|-------------------|-----------------------------------------|--------------------|-------------------|
| userName          | 必須、最大100文字                       | テンプレート生成前  | MSG_VAL_NT001_01  |
| verificationUrl   | 必須、URL形式、255文字以内             | テンプレート生成前  | MSG_VAL_NT001_02  |
| expirationHours   | 整数、>=1                                | テンプレート生成前  | MSG_VAL_NT001_03  |
| supportEmail      | 必須、メールアドレス形式                | テンプレート生成前  | MSG_VAL_NT001_04  |

## 9. 送信フロー

1. フロントエンドが `POST /api/auth/register` リクエストを送信  
2. サーバー側で入力バリデーション・重複チェックを実行  
3. 新規ユーザー情報を `users` テーブルに保存  
4. メール確認用トークンを生成し、`email_verifications` テーブルに保存（有効期限24時間）  
5. バックエンドからメールサービス（SMTP／ESMTP／メールAPI）に送信依頼  
6. メール送信成功時、レスポンスで登録完了をフロントへ返却  
7. ユーザーがメール内リンクをクリック → **GET** `/api/auth/verify?token=…` へ遷移 → トークン検証・有効化処理

## 10. 処理イベント

| イベント                | フロント処理                                | サーバー処理                                               | 成功時操作                             | エラー時操作                            |
|-----------------------|-------------------------------------------|----------------------------------------------------------|--------------------------------------|---------------------------------------|
| 登録申請ボタンクリック    | 入力チェック → ボタン無効化 → POST送信         | バリデーション → ユーザー登録 → トークン生成 → メール送信   | レスポンス受信 → 完了画面表示 → ボタン有効化 | エラーメッセージ表示 → ボタン有効化         |
| メール送信            | —                                         | SMTP/API呼び出し → 送信結果ログ                             | ログに「送信成功」記録                | ログに「送信失敗」記録・リトライキュー登録 |
| 確認リンククリック      | —                                         | トークン検証 → `users.verified = true` 更新                | 確認完了画面表示                      | エラー画面（トークン無効／期限切れ）表示       |